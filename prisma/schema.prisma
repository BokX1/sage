datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model UserProfile {
  userId    String   @id
  summary   String   @default("") // Compressed memory: preferences, stable facts
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model ChannelMessage {
  messageId         String   @id
  guildId           String?
  channelId         String
  authorId          String
  authorDisplayName String
  timestamp         DateTime
  content           String   @db.Text
  replyToMessageId  String?
  mentionsUserIds   Json
  mentionsBot       Boolean  @default(false)

  @@index([guildId, channelId, timestamp])
}

model ChannelSummary {
  id              String   @id @default(cuid())
  guildId         String
  channelId       String
  kind            String
  windowStart     DateTime
  windowEnd       DateTime
  summaryText     String
  topicsJson      Json?
  threadsJson     Json?
  unresolvedJson  Json?
  decisionsJson   Json?
  actionItemsJson Json?
  sentiment       String?
  glossaryJson    Json?
  updatedAt       DateTime @updatedAt

  @@unique([guildId, channelId, kind])
  @@index([guildId, channelId, updatedAt])
}

model VoiceSession {
  id          String   @id @default(cuid())
  guildId     String
  channelId   String
  userId      String
  displayName String?
  startedAt   DateTime
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId, channelId, startedAt])
  @@index([guildId, userId, startedAt])
  @@index([guildId, userId, endedAt])
}

model RelationshipEdge {
  id             String   @id @default(cuid())
  guildId        String
  userA          String   // Always userA < userB (lexicographically)
  userB          String
  weight         Float    @default(0) // 0.0-1.0 relationship strength
  confidence     Float    @default(0) // 0.0-1.0 evidence strength
  featuresJson   Json     // { mentions, replies, voice, meta }
  manualOverride Float?   // Admin-set override (0.0-1.0)
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  @@unique([guildId, userA, userB])
  @@index([guildId, updatedAt])
}

model AdminAudit {
  id         String   @id @default(cuid())
  guildId    String
  adminId    String
  command    String
  paramsHash String   // SHA256 of normalized params JSON
  createdAt  DateTime @default(now())

  @@index([guildId, createdAt])
}

model AgentTrace {
  id           String   @id
  guildId      String?
  channelId    String
  userId       String
  routeKind    String
  routerJson   Json
  expertsJson  Json
  toolJson     Json?
  tokenJson    Json?
  replyText    String   @db.Text
  createdAt    DateTime @default(now())

  @@index([guildId, createdAt])
  @@index([channelId, createdAt])
  @@index([userId, createdAt])
}
