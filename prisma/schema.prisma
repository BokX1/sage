datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model UserProfile {
  userId    String   @id
  summary   String   @default("") // Compressed memory: preferences, stable facts
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model ChannelMessage {
  messageId         String   @id
  guildId           String?
  channelId         String
  authorId          String
  authorDisplayName String
  timestamp         DateTime
  content           String   @db.Text
  replyToMessageId  String?
  mentionsUserIds   Json
  mentionsBot       Boolean  @default(false)

  @@index([guildId, channelId, timestamp])
}

model ChannelSummary {
  id             String   @id @default(cuid())
  guildId        String
  channelId      String
  kind           String
  windowStart    DateTime
  windowEnd      DateTime
  summaryText    String
  topicsJson     Json?
  threadsJson    Json?
  unresolvedJson Json?
  glossaryJson   Json?
  updatedAt      DateTime @updatedAt

  @@unique([guildId, channelId, kind])
  @@index([guildId, channelId, updatedAt])
}

model VoiceSession {
  id          String   @id @default(cuid())
  guildId     String
  channelId   String
  userId      String
  displayName String?
  startedAt   DateTime
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId, channelId, startedAt])
  @@index([guildId, userId, startedAt])
  @@index([guildId, userId, endedAt])
}
